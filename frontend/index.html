<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Phygital - Bridge Physical to Digital</title>
    <meta name="description" content="Transform your physical designs into interactive digital experiences with QR codes and videos." />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- AR Libraries - Load before React app -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.149.0/build/three.min.js"></script>
    <script src="https://hammerjs.github.io/dist/hammer.min.js"></script>
    
    <!-- Load MindAR from a working UMD build -->
    <script>
      // Create a simple MindAR loader
      (function() {
        console.log('🔄 Loading MindAR...');
        
          // Try to load from a working CDN
          const script = document.createElement('script');
          script.src = 'https://cdn.skypack.dev/mind-ar@1.2.2/dist/mindar-image-three.prod.js';
        script.crossOrigin = 'anonymous';
        
        script.onload = function() {
          console.log('✅ MindAR script loaded');
          // Check if MindAR is available and try to expose it
          setTimeout(() => {
            // Check various possible global names
            const possibleNames = ['MindARThree', 'MINDAR', 'mindAR', 'MindAR'];
            let found = false;
            
            for (const name of possibleNames) {
              if (window[name]) {
                window.MindARThree = window[name];
                console.log(`✅ MindAR found as window.${name} and mapped to MindARThree`);
                found = true;
                break;
              }
            }
            
            if (!found) {
              console.log('⚠️ MindAR loaded but not found on window');
              console.log('Available on window:', Object.keys(window).filter(k => k.toLowerCase().includes('mind')));
              
              // Create enhanced stub immediately since MindAR isn't available
              console.log('🔄 Creating enhanced MindAR stub with camera...');
              window.MindARThree = {
                MindARThree: function(config) {
                  console.log('🧪 Using enhanced MindAR stub with camera');
                  this.container = config.container;
                  this.imageTargetSrc = config.imageTargetSrc;
                  
                  // Create canvas for camera simulation
                  const canvas = document.createElement('canvas');
                  canvas.width = 640;
                  canvas.height = 480;
                  canvas.style.width = '100%';
                  canvas.style.height = '100%';
                  canvas.style.objectFit = 'cover';
                  
                  // Add camera simulation
                  const ctx = canvas.getContext('2d');
                  
                  // Try to get real camera access
                  const startCamera = async () => {
                    try {
                      console.log('🎥 Attempting to access camera...');
                      const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                          facingMode: 'environment',
                          width: { ideal: 640 },
                          height: { ideal: 480 }
                        } 
                      });
                      
                      const video = document.createElement('video');
                      video.srcObject = stream;
                      video.autoplay = true;
                      video.playsInline = true;
                      video.muted = true;
                      
                      video.onloadedmetadata = () => {
                        console.log('✅ Camera stream active');
                        console.log('📹 Video dimensions:', video.videoWidth, 'x', video.videoHeight);
                        console.log('🎨 Canvas dimensions:', canvas.width, 'x', canvas.height);
                        
                        // Draw video to canvas
                        const drawFrame = () => {
                          if (video.readyState === video.HAVE_ENOUGH_DATA) {
                            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                            // Add a large indicator to show drawing is working
                            ctx.fillStyle = 'lime';
                            ctx.fillRect(10, 10, 100, 50);
                            ctx.fillStyle = 'black';
                            ctx.font = '20px Arial';
                            ctx.fillText('LIVE CAMERA', 15, 35);
                            
                            // Ensure canvas stays visible
                            if (canvas.style.zIndex !== '8888') {
                              canvas.style.zIndex = '8888';
                              console.log('🔧 Canvas z-index restored to 8888');
                            }
                          } else {
                            // Draw fallback when video not ready
                            ctx.fillStyle = '#ff0000';
                            ctx.fillRect(0, 0, canvas.width, canvas.height);
                            ctx.fillStyle = '#ffffff';
                            ctx.font = '24px Arial';
                            ctx.textAlign = 'center';
                            ctx.fillText('WAITING FOR CAMERA...', canvas.width/2, canvas.height/2);
                          }
                          requestAnimationFrame(drawFrame);
                        };
                        drawFrame();
                        console.log('🎬 Video drawing started');
                      };
                      
                      return stream;
                    } catch (error) {
                      console.log('❌ Camera access failed:', error.message);
                      // Draw placeholder
                      ctx.fillStyle = '#1a1a1a';
                      ctx.fillRect(0, 0, canvas.width, canvas.height);
                      ctx.fillStyle = '#666';
                      ctx.font = '20px Arial';
                      ctx.textAlign = 'center';
                      ctx.fillText('Camera Access Required', canvas.width/2, canvas.height/2 - 20);
                      ctx.fillText('Allow camera permission', canvas.width/2, canvas.height/2 + 20);
                      return null;
                    }
                  };
                  
                  return {
                    start: async function() {
                      console.log('🧪 Enhanced stub start called');
                      console.log('🧪 Container received:', config.container);
                      // Ensure canvas is properly styled and visible (use fixed positioning like test canvas)
                      canvas.style.position = 'fixed';
                      canvas.style.top = '0';
                      canvas.style.left = '0';
                      canvas.style.width = '100vw';
                      canvas.style.height = '100vh';
                      canvas.style.zIndex = '8888';
                      canvas.style.backgroundColor = '#000000';
                      canvas.style.pointerEvents = 'none';
                      canvas.style.objectFit = 'cover';
                      canvas.style.display = 'block';
                      console.log('🎨 Camera canvas styled with position:fixed and z-index 8888');
                      
                      config.container.appendChild(canvas);
                      console.log('📺 Canvas added to container:', config.container);
                      console.log('📺 Container children count:', config.container.children.length);
                      console.log('📺 Container children:', Array.from(config.container.children).map(child => ({
                        tagName: child.tagName,
                        className: child.className,
                        zIndex: child.style.zIndex || getComputedStyle(child).zIndex
                      })));
                      
                      // Draw initial placeholder to ensure canvas is visible
                      ctx.fillStyle = '#ff0000'; // Bright red background
                      ctx.fillRect(0, 0, canvas.width, canvas.height);
                      ctx.fillStyle = '#ffffff'; // White text
                      ctx.font = '32px Arial';
                      ctx.textAlign = 'center';
                      ctx.fillText('CAMERA LOADING...', canvas.width/2, canvas.height/2 - 20);
                      ctx.fillText('RED SCREEN = CANVAS WORKING', canvas.width/2, canvas.height/2 + 20);
                      console.log('🎨 Initial RED placeholder drawn');
                      console.log('🎨 Canvas dimensions:', canvas.width, 'x', canvas.height);
                      console.log('🎨 Canvas style:', {
                        position: canvas.style.position,
                        top: canvas.style.top,
                        left: canvas.style.left,
                        width: canvas.style.width,
                        height: canvas.style.height,
                        zIndex: canvas.style.zIndex,
                        display: canvas.style.display
                      });
                      
                      await startCamera();
                      return Promise.resolve();
                    },
                    stop: async function() {
                      console.log('🧪 Enhanced stub stop called');
                      if (canvas.parentNode) {
                        canvas.parentNode.removeChild(canvas);
                      }
                      return Promise.resolve();
                    },
                    addAnchor: function(index) {
                      console.log('🧪 Enhanced stub addAnchor called');
                      return {
                        group: {
                          add: function(mesh) {
                            console.log('🧪 Enhanced stub group.add called');
                          }
                        }
                      };
                    },
                    renderer: {
                      domElement: canvas
                    },
                    scene: new window.THREE.Scene(),
                    camera: new window.THREE.PerspectiveCamera(),
                    onTargetFound: null,
                    onTargetLost: null
                  };
                }
              };
              
                console.log('✅ Enhanced MindAR stub created');
                console.log('🧪 Stub MindARThree constructor available:', typeof window.MindARThree.MindARThree);
                
                console.log('🧪 Canvas rendering confirmed working!');
            }
            
            console.log('📊 Final library check:', {
              THREE: !!window.THREE,
              MindARThree: !!window.MindARThree,
              MINDAR: !!window.MINDAR,
              Hammer: !!window.Hammer
            });
          }, 500);
        };
        
        script.onerror = function() {
          console.error('❌ Failed to load MindAR from npm CDN');
          
          // Fallback: Try loading from unpkg
          console.log('🔄 Trying unpkg fallback...');
          
            const fallbackScript = document.createElement('script');
            fallbackScript.src = 'https://cdn.skypack.dev/mind-ar@1.2.2';
          fallbackScript.crossOrigin = 'anonymous';
          
          fallbackScript.onload = function() {
            console.log('✅ MindAR loaded from unpkg fallback');
            setTimeout(() => {
              if (window.MindARThree) {
                console.log('✅ Real MindARThree is available');
              } else if (window.MINDAR) {
                window.MindARThree = window.MINDAR;
                console.log('✅ Real MindAR mapped from MINDAR');
              }
            }, 500);
          };
          
          fallbackScript.onerror = function() {
            console.error('❌ All MindAR loading attempts failed, using stub');
            
              // Create an enhanced MindAR stub with camera access
              window.MindARThree = {
                MindARThree: function(config) {
                  console.log('🧪 Using enhanced MindAR stub with camera');
                  console.log('🧪 Config received:', config);
                  this.container = config.container;
                  this.imageTargetSrc = config.imageTargetSrc;
                  
                  // Create canvas for camera simulation
                  const canvas = document.createElement('canvas');
                  canvas.width = 640;
                  canvas.height = 480;
                  console.log('🧪 Canvas created:', canvas);
                  
                  // Style canvas immediately (use fixed positioning)
                  canvas.style.position = 'fixed';
                  canvas.style.top = '0';
                  canvas.style.left = '0';
                  canvas.style.width = '100vw';
                  canvas.style.height = '100vh';
                  canvas.style.zIndex = '8888';
                  canvas.style.backgroundColor = '#000000';
                  canvas.style.pointerEvents = 'none';
                  canvas.style.objectFit = 'cover';
                  canvas.style.display = 'block';
                  console.log('🧪 Camera canvas styled immediately with position:fixed');
                  
                  // Add canvas to body immediately for testing
                  document.body.appendChild(canvas);
                  console.log('🧪 Canvas added to body immediately');
              
              // Add camera simulation
              const ctx = canvas.getContext('2d');
              
              // Draw red placeholder immediately
              ctx.fillStyle = '#ff0000';
              ctx.fillRect(0, 0, canvas.width, canvas.height);
              ctx.fillStyle = '#ffffff';
              ctx.font = '32px Arial';
              ctx.textAlign = 'center';
              ctx.fillText('STUB CANVAS WORKING!', canvas.width/2, canvas.height/2 - 20);
              ctx.fillText('CAMERA STARTING...', canvas.width/2, canvas.height/2 + 20);
              console.log('🧪 Red placeholder drawn immediately');
              
              // Try to get real camera access
              const startCamera = async () => {
                try {
                  console.log('🎥 Attempting to access camera...');
                  const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                      facingMode: 'environment',
                      width: { ideal: 640 },
                      height: { ideal: 480 }
                    } 
                  });
                  
                  const video = document.createElement('video');
                  video.srcObject = stream;
                  video.autoplay = true;
                  video.playsInline = true;
                  video.muted = true;
                  
                  video.onloadedmetadata = () => {
                    console.log('✅ Camera stream active');
                    // Draw video to canvas
                    const drawFrame = () => {
                      if (video.readyState === video.HAVE_ENOUGH_DATA) {
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                      }
                      requestAnimationFrame(drawFrame);
                    };
                    drawFrame();
                  };
                  
                  return stream;
                } catch (error) {
                  console.log('❌ Camera access failed:', error.message);
                  // Draw placeholder
                  ctx.fillStyle = '#1a1a1a';
                  ctx.fillRect(0, 0, canvas.width, canvas.height);
                  ctx.fillStyle = '#666';
                  ctx.font = '20px Arial';
                  ctx.textAlign = 'center';
                  ctx.fillText('Camera Access Required', canvas.width/2, canvas.height/2 - 20);
                  ctx.fillText('Allow camera permission', canvas.width/2, canvas.height/2 + 20);
                  return null;
                }
              };
              
              return {
                start: async function() {
                  console.log('🧪 Enhanced stub start called');
                  config.container.appendChild(canvas);
                  await startCamera();
                  return Promise.resolve();
                },
                stop: async function() {
                  console.log('🧪 Enhanced stub stop called');
                  if (canvas.parentNode) {
                    canvas.parentNode.removeChild(canvas);
                  }
                  return Promise.resolve();
                },
                addAnchor: function(index) {
                  console.log('🧪 Enhanced stub addAnchor called');
                  return {
                    group: {
                      add: function(mesh) {
                        console.log('🧪 Enhanced stub group.add called');
                      }
                    }
                  };
                },
                renderer: {
                  domElement: canvas
                },
                scene: new window.THREE.Scene(),
                camera: new window.THREE.PerspectiveCamera(),
                onTargetFound: null,
                onTargetLost: null
              };
            }
          };
          
          console.log('✅ MindAR stub created for testing');
          };
          
          document.head.appendChild(fallbackScript);
        };
        
        document.head.appendChild(script);
      })();
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
