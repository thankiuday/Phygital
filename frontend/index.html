<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Phygital - Bridge Physical to Digital</title>
    <meta name="description" content="Transform your physical designs into interactive digital experiences with QR codes and videos." />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- AR Libraries - Load before React app -->
    <script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>
    <script src="https://hammerjs.github.io/dist/hammer.min.js"></script>
    
    <!-- Load MindAR from a working UMD build -->
    <script>
      // Create a simple MindAR loader
      (function() {
        console.log('üîÑ Loading MindAR...');
        
        // Try to load from a CDN that provides UMD builds
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-three.prod.js';
        script.crossOrigin = 'anonymous';
        
        script.onload = function() {
          console.log('‚úÖ MindAR script loaded');
          // Check if MindAR is available and try to expose it
          setTimeout(() => {
            // Check various possible global names
            const possibleNames = ['MindARThree', 'MINDAR', 'mindAR', 'MindAR'];
            let found = false;
            
            for (const name of possibleNames) {
              if (window[name]) {
                window.MindARThree = window[name];
                console.log(`‚úÖ MindAR found as window.${name} and mapped to MindARThree`);
                found = true;
                break;
              }
            }
            
            if (!found) {
              console.log('‚ö†Ô∏è MindAR loaded but not found on window');
              console.log('Available on window:', Object.keys(window).filter(k => k.toLowerCase().includes('mind')));
              
              // Create enhanced stub immediately since MindAR isn't available
              console.log('üîÑ Creating enhanced MindAR stub with camera...');
              window.MindARThree = {
                MindARThree: function(config) {
                  console.log('üß™ Using enhanced MindAR stub with camera');
                  this.container = config.container;
                  this.imageTargetSrc = config.imageTargetSrc;
                  
                  // Create canvas for camera simulation
                  const canvas = document.createElement('canvas');
                  canvas.width = 640;
                  canvas.height = 480;
                  canvas.style.width = '100%';
                  canvas.style.height = '100%';
                  canvas.style.objectFit = 'cover';
                  
                  // Add camera simulation
                  const ctx = canvas.getContext('2d');
                  
                  // Try to get real camera access
                  const startCamera = async () => {
                    try {
                      console.log('üé• Attempting to access camera...');
                      const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                          facingMode: 'environment',
                          width: { ideal: 640 },
                          height: { ideal: 480 }
                        } 
                      });
                      
                      const video = document.createElement('video');
                      video.srcObject = stream;
                      video.autoplay = true;
                      video.playsInline = true;
                      video.muted = true;
                      
                      video.onloadedmetadata = () => {
                        console.log('‚úÖ Camera stream active');
                        console.log('üìπ Video dimensions:', video.videoWidth, 'x', video.videoHeight);
                        console.log('üé® Canvas dimensions:', canvas.width, 'x', canvas.height);
                        
                        // Draw video to canvas
                        const drawFrame = () => {
                          if (video.readyState === video.HAVE_ENOUGH_DATA) {
                            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                            // Add a small indicator to show drawing is working
                            ctx.fillStyle = 'lime';
                            ctx.fillRect(10, 10, 20, 20);
                            ctx.fillStyle = 'white';
                            ctx.font = '12px Arial';
                            ctx.fillText('LIVE', 15, 25);
                          }
                          requestAnimationFrame(drawFrame);
                        };
                        drawFrame();
                        console.log('üé¨ Video drawing started');
                      };
                      
                      return stream;
                    } catch (error) {
                      console.log('‚ùå Camera access failed:', error.message);
                      // Draw placeholder
                      ctx.fillStyle = '#1a1a1a';
                      ctx.fillRect(0, 0, canvas.width, canvas.height);
                      ctx.fillStyle = '#666';
                      ctx.font = '20px Arial';
                      ctx.textAlign = 'center';
                      ctx.fillText('Camera Access Required', canvas.width/2, canvas.height/2 - 20);
                      ctx.fillText('Allow camera permission', canvas.width/2, canvas.height/2 + 20);
                      return null;
                    }
                  };
                  
                  return {
                    start: async function() {
                      console.log('üß™ Enhanced stub start called');
                      // Ensure canvas is properly styled and visible
                      canvas.style.position = 'absolute';
                      canvas.style.top = '0';
                      canvas.style.left = '0';
                      canvas.style.width = '100%';
                      canvas.style.height = '100%';
                      canvas.style.zIndex = '1';
                      canvas.style.backgroundColor = '#000';
                      console.log('üé® Canvas z-index set to 1 (background layer)');
                      
                      config.container.appendChild(canvas);
                      console.log('üì∫ Canvas added to container:', config.container);
                      
                      // Draw initial placeholder to ensure canvas is visible
                      ctx.fillStyle = '#1a1a1a';
                      ctx.fillRect(0, 0, canvas.width, canvas.height);
                      ctx.fillStyle = '#00ff00';
                      ctx.font = '24px Arial';
                      ctx.textAlign = 'center';
                      ctx.fillText('CAMERA LOADING...', canvas.width/2, canvas.height/2);
                      console.log('üé® Initial placeholder drawn');
                      
                      await startCamera();
                      return Promise.resolve();
                    },
                    stop: async function() {
                      console.log('üß™ Enhanced stub stop called');
                      if (canvas.parentNode) {
                        canvas.parentNode.removeChild(canvas);
                      }
                      return Promise.resolve();
                    },
                    addAnchor: function(index) {
                      console.log('üß™ Enhanced stub addAnchor called');
                      return {
                        group: {
                          add: function(mesh) {
                            console.log('üß™ Enhanced stub group.add called');
                          }
                        }
                      };
                    },
                    renderer: {
                      domElement: canvas
                    },
                    scene: new window.THREE.Scene(),
                    camera: new window.THREE.PerspectiveCamera(),
                    onTargetFound: null,
                    onTargetLost: null
                  };
                }
              };
              
              console.log('‚úÖ Enhanced MindAR stub created');
            }
            
            console.log('üìä Final library check:', {
              THREE: !!window.THREE,
              MindARThree: !!window.MindARThree,
              MINDAR: !!window.MINDAR,
              Hammer: !!window.Hammer
            });
          }, 500);
        };
        
        script.onerror = function() {
          console.error('‚ùå Failed to load MindAR from npm CDN');
          
          // Fallback: Try loading from unpkg
          console.log('üîÑ Trying unpkg fallback...');
          
          const fallbackScript = document.createElement('script');
          fallbackScript.src = 'https://unpkg.com/mind-ar@1.2.2/dist/mindar-image-three.prod.js';
          fallbackScript.crossOrigin = 'anonymous';
          
          fallbackScript.onload = function() {
            console.log('‚úÖ MindAR loaded from unpkg fallback');
            setTimeout(() => {
              if (window.MindARThree) {
                console.log('‚úÖ Real MindARThree is available');
              } else if (window.MINDAR) {
                window.MindARThree = window.MINDAR;
                console.log('‚úÖ Real MindAR mapped from MINDAR');
              }
            }, 500);
          };
          
          fallbackScript.onerror = function() {
            console.error('‚ùå All MindAR loading attempts failed, using stub');
            
            // Create an enhanced MindAR stub with camera access
            window.MindARThree = {
            MindARThree: function(config) {
              console.log('üß™ Using enhanced MindAR stub with camera');
              this.container = config.container;
              this.imageTargetSrc = config.imageTargetSrc;
              
              // Create canvas for camera simulation
              const canvas = document.createElement('canvas');
              canvas.width = 640;
              canvas.height = 480;
              canvas.style.width = '100%';
              canvas.style.height = '100%';
              canvas.style.objectFit = 'cover';
              
              // Add camera simulation
              const ctx = canvas.getContext('2d');
              
              // Try to get real camera access
              const startCamera = async () => {
                try {
                  console.log('üé• Attempting to access camera...');
                  const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                      facingMode: 'environment',
                      width: { ideal: 640 },
                      height: { ideal: 480 }
                    } 
                  });
                  
                  const video = document.createElement('video');
                  video.srcObject = stream;
                  video.autoplay = true;
                  video.playsInline = true;
                  video.muted = true;
                  
                  video.onloadedmetadata = () => {
                    console.log('‚úÖ Camera stream active');
                    // Draw video to canvas
                    const drawFrame = () => {
                      if (video.readyState === video.HAVE_ENOUGH_DATA) {
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                      }
                      requestAnimationFrame(drawFrame);
                    };
                    drawFrame();
                  };
                  
                  return stream;
                } catch (error) {
                  console.log('‚ùå Camera access failed:', error.message);
                  // Draw placeholder
                  ctx.fillStyle = '#1a1a1a';
                  ctx.fillRect(0, 0, canvas.width, canvas.height);
                  ctx.fillStyle = '#666';
                  ctx.font = '20px Arial';
                  ctx.textAlign = 'center';
                  ctx.fillText('Camera Access Required', canvas.width/2, canvas.height/2 - 20);
                  ctx.fillText('Allow camera permission', canvas.width/2, canvas.height/2 + 20);
                  return null;
                }
              };
              
              return {
                start: async function() {
                  console.log('üß™ Enhanced stub start called');
                  config.container.appendChild(canvas);
                  await startCamera();
                  return Promise.resolve();
                },
                stop: async function() {
                  console.log('üß™ Enhanced stub stop called');
                  if (canvas.parentNode) {
                    canvas.parentNode.removeChild(canvas);
                  }
                  return Promise.resolve();
                },
                addAnchor: function(index) {
                  console.log('üß™ Enhanced stub addAnchor called');
                  return {
                    group: {
                      add: function(mesh) {
                        console.log('üß™ Enhanced stub group.add called');
                      }
                    }
                  };
                },
                renderer: {
                  domElement: canvas
                },
                scene: new window.THREE.Scene(),
                camera: new window.THREE.PerspectiveCamera(),
                onTargetFound: null,
                onTargetLost: null
              };
            }
          };
          
          console.log('‚úÖ MindAR stub created for testing');
          };
          
          document.head.appendChild(fallbackScript);
        };
        
        document.head.appendChild(script);
      })();
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
