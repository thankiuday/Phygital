<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>Phygital - Bridge Physical to Digital - v3</title>
    <!-- Deployment: 2024-09-27-Force-Update-5 -->
    <script>console.log('Deployment test - new build loaded - v5 - Syntax Fixed');</script>
    <meta name="description" content="Transform your physical designs into interactive digital experiences with QR codes and videos." />
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#3b82f6" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Phygital AR" />
    
    <!-- Camera and AR Permissions -->
    <meta name="permissions" content="camera" />
    <meta name="mobile-web-app-capable" content="yes" />
    
    <!-- Import Map to resolve "three" for MindAR -->
    <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js"
      }
    }
    </script>
    
    <!-- Preload critical resources -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
    <link rel="preconnect" href="https://unpkg.com" crossorigin />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- HammerJS (non-ESM, so fine) -->
    <script src="https://hammerjs.github.io/dist/hammer.min.js"></script>
    
    <!-- Load MindAR as ES module with import map resolution -->
    <script type="module">
      // Load Three.js via import map and expose globally
      import * as THREE from "three";
      window.THREE = THREE;
      console.log("✅ Three.js loaded via import map");
      
      // Load MindAR with fallbacks
        const mindARSources = [
          'https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js',
          'https://unpkg.com/mind-ar@1.2.5/dist/mindar-image-three.prod.js',
          'https://cdn.skypack.dev/mind-ar@1.2.5/dist/mindar-image-three.prod.js'
        ];
        
        let currentSourceIndex = 0;
        
      async function loadMindAR() {
          if (currentSourceIndex >= mindARSources.length) {
          console.error('❌ All MindAR sources failed, using stub');
          createStub();
            return;
          }
        
        try {
          console.log(`🔄 Loading MindAR from source ${currentSourceIndex + 1}...`);
          const module = await import(mindARSources[currentSourceIndex]);
          
          // Handle different export patterns
          if (module.MindARThree) {
            window.MindARThree = module.MindARThree;
            console.log(`✅ MindAR loaded from source ${currentSourceIndex + 1} as MindARThree`);
          } else if (module.default) {
            window.MindARThree = module.default;
            console.log(`✅ MindAR loaded from source ${currentSourceIndex + 1} as default`);
          } else {
            // Try to find any export that looks like MindARThree
            const exports = Object.keys(module);
            const mindARExport = exports.find(key => 
              key.toLowerCase().includes('mindar') || 
              typeof module[key] === 'function'
            );
            
            if (mindARExport) {
              window.MindARThree = module[mindARExport];
              console.log(`✅ MindAR loaded from source ${currentSourceIndex + 1} as ${mindARExport}`);
            } else {
              throw new Error('No valid MindAR export found');
            }
            }
            
            console.log('📊 Final library check:', {
              THREE: !!window.THREE,
              MindARThree: !!window.MindARThree,
              Hammer: !!window.Hammer
            });
        
        } catch (error) {
          console.error(`❌ Failed to load MindAR from source ${currentSourceIndex + 1}:`, error.message);
          currentSourceIndex++;
          await loadMindAR();
        }
      }
      
      function createStub() {
        console.log('🧪 Using fallback MindAR stub');
        window.MindARThree = {
                MindARThree: function(config) {
            console.log('Stubbed MindAR initialized:', config);
                  return {
              start: async () => { console.log('Stub start'); },
              stop: async () => { console.log('Stub stop'); },
              addAnchor: () => ({ group: { add: () => {} } }),
              renderer: { domElement: document.createElement('canvas') },
                    scene: new window.THREE.Scene(),
              camera: new window.THREE.PerspectiveCamera()
                  };
                }
              };
      }
      
      // Start loading MindAR
      loadMindAR();
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
